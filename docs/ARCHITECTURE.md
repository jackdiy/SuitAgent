# 架构文档

> Last updated: 2025-11-01
> 本文档描述SuitAgent系统的整体架构、核心组件、数据流和设计原则。

## 目录
- [系统概述](#系统概述)
- [核心设计原则](#核心设计原则)
- [系统架构](#系统架构)
- [10个核心工作流](#10个核心工作流)
- [三层质量保障体系](#三层质量保障体系)
- [记忆分层系统](#记忆分层系统)
- [自动化工作流编排](#自动化工作流编排)
- [文档管理架构](#文档管理架构)
- [数据流设计](#数据流设计)
- [技术栈](#技术栈)
- [部署架构](#部署架构)

---

## 系统概述

SuitAgent是一个基于Claude Code架构的模块化法律文书生成系统，通过**10个专用工作流**实现诉讼案件的自动化分析、法律检索、策略规划和文书起草。系统采用Sub-Workflows设计，支持上下文最小化、可重入和并行执行。

核心特性包括：
- **10个AI代理协作**：DocAnalyzer、EvidenceAnalyzer、IssueIdentifier、Researcher、Strategist、Writer、Summarizer、Reporter、Scheduler、**Reviewer**
- **三层质量保障体系**：内嵌验证 + 专项审查 + Reviewer智能审查
- **自动化编排**：支持15种场景的智能识别和自动工作流选择
- **记忆分层系统**：案件级、个人级、系统级三层记忆架构
- **智能文档管理**：自动化分类、路径标准化、YAML数据看板

## 核心设计原则

### 1. 模块化 (Modularity)
每个工作流独立负责一个特定功能，职责单一，便于开发、测试和维护。

### 2. 上下文最小化 (Context Minimization)
每个工作流在极小的上下文环境中运行，避免token膨胀和上下文污染。

### 3. 可重入设计 (Re-entrant Design)
支持迭代优化和循环检索，允许工作流多次执行以达到最佳结果。

### 4. 工程化流程 (Engineering Process)
- 可视化工作流执行
- 支持并行执行提高效率
- 完整的状态追踪机制
- 实时进度监控

### 5. 多格式支持 (Multi-format Support)
输入支持.docx和.pdf，输出支持.md、.docx和.pdf，满足不同使用场景需求。

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     SuitAgent 系统架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │
│  │   输入层 (Input)│    │  工作流引擎      │    │  输出层 (Output) │  │
│  │                 │    │  (Engine)       │    │                 │  │
│  │  - .docx        │───▶│                 │───▶│  - .md          │  │
│  │  - .pdf         │    │  - 调度器       │    │  - .docx        │  │
│  └─────────────────┘    │  - 状态管理      │    │  - .pdf         │  │
│                         │  - 并行执行      │    └─────────────────┘  │
│                         │  - 上下文传递    │                         │
│                         └─────────────────┘                         │
│                                   │                                 │
│                        ┌──────────┴──────────┐                      │
│                        │                     │                      │
│                   ┌────▼────┐          ┌────▼────┐                 │
│                   │数据存储 │          │监控日志 │                 │
│                   │(Data)   │          │(Monitor)│                 │
│                   └─────────┘          └─────────┘                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. 工作流引擎 (Workflow Engine)
- **调度器 (Scheduler)**: 负责任务分发和执行顺序
- **状态管理器 (State Manager)**: 跟踪每个工作流的状态
- **上下文管理器 (Context Manager)**: 管理轻量级上下文传递
- **并行执行器 (Parallel Executor)**: 支持工作流并行执行

#### 2. 工作流层 (Workflow Layer)
10个专用工作流，按数据流向排列：
1. DocAnalyzer → 2. EvidenceAnalyzer → 3. IssueIdentifier
4. Researcher → 5. Strategist → 6. Writer
7. Summarizer → 8. Reporter → 9. Scheduler
10. **Reviewer** (智能审查器，作为Subagent被调用)

#### 3. 数据层 (Data Layer)
- **输入缓存**: 临时存储原始文档
- **中间结果**: 存储各工作流的输出
- **最终报告**: 存储完整的分析报告
- **状态快照**: 保存执行进度和状态

#### 记忆分层系统 (Memory Hierarchy System)

**设计理念**：基于Claude Code架构设计，为所有Agent提供分层的上下文记忆支持，实现智能协作和个性化服务。

**Claude Code架构中的记忆位置**：
- **根目录 `claude.md`** - 全局记忆文件
- **`.claude/memory/` 文件夹** - 各类记忆存储
- **`.claude/skills/` 文件夹** - 技能绑定记忆（按需加载）

**三层记忆架构**：

**1. 案件级记忆** (Case-Level)
- 位置：`output/[案件编号]/06_日程管理/[案件编号].md`
- 格式：Markdown
- 内容：案件上下文、工作记录、时间线、状态变更、决策历史
- 访问：Agent处理案件时自动加载
- 生命周期：案件全程
- 更新机制：Agent自动更新

**2. 个人级记忆** (Personal-Level)
- 位置：`.claude/memory/` 文件夹
- 格式：Markdown
- 内容：律师偏好、工作习惯、个性化设置、常用模板、效率优化
- 访问：通过memory机制加载
- 生命周期：长期保持
- 更新机制：人工审核后修改

**3. 系统级记忆** (System-Level)
- 位置：根目录 `claude.md` 文件
- 格式：Markdown
- 内容：全局配置、系统规则、法律知识库、共享经验、最佳实践
- 访问：作为全局上下文默认加载
- 生命周期：永久维护
- 更新机制：人工审核后修改

**工作原理**：
1. **记忆加载**：Agent启动时通过系统提示手动加载需要的记忆
2. **上下文融合**：记忆内容作为Agent决策和执行的上下文基础
3. **智能应用**：Agent基于记忆提供个性化的智能服务
4. **分级更新**：
   - 案件级：Agent自动更新工作记录和状态变更
   - 个人/系统级：需要人工审核后修改

#### 4. 监控层 (Monitoring Layer)
- **执行日志**: 记录所有操作和结果
- **性能指标**: 监控运行时间和资源消耗
- **错误追踪**: 记录和追踪错误信息
- **进度报告**: 提供实时执行进度

---

## 8个核心工作流

### 1. DocAnalyzer - 起诉文档解析器
**职责**: 解析输入的.docx/.pdf文档，提取结构化信息
**输入**: 原始诉讼文档 (.docx/.pdf)
**输出**: 结构化文档数据 (JSON/Markdown)
**关键功能**:
- 文档格式识别和解析
- 文本提取和清理
- 结构化数据抽取
- 元数据识别

### 2. EvidenceAnalyzer - 证据分析器
**职责**: 分析和评估证据材料的完整性和有效性
**输入**: DocAnalyzer的结构化数据
**输出**: 证据分析报告
**关键功能**:
- 证据分类和标记
- 完整性检查
- 可靠性评估
- 关联性分析

### 3. IssueIdentifier - 争议焦点识别器
**职责**: 从文档中识别和提取核心法律争议点
**输入**: DocAnalyzer + EvidenceAnalyzer数据
**输出**: 争议焦点清单
**关键功能**:
- 争议点提取
- 法律问题分类
- 优先级排序
- 争议复杂度评估

### 4. Researcher - 判例法条检索器
**职责**: 检索相关的判例、法条和司法解释
**输入**: IssueIdentifier的争议焦点
**输出**: 相关法条和判例集合
**关键功能**:
- 关键词匹配
- 相似案例检索
- 法条引用分析
- 时效性检查

### 5. Strategist - 法律策略规划器
**职责**: 基于争议焦点和法条检索结果制定诉讼策略
**输入**: IssueIdentifier + Researcher数据
**输出**: 诉讼策略方案
**关键功能**:
- 策略方案生成
- 风险评估
- 成功率预测
- 备选方案设计

### 6. Writer - 法律文书起草器
**职责**: 根据策略和模板起草法律文书
**输入**: Strategist策略方案
**输出**: 草稿法律文书
**关键功能**:
- 模板匹配
- 内容生成
- 格式规范
- 逻辑一致性检查

### 7. Summarizer - 报告摘要生成器
**职责**: 生成完整的案件分析摘要
**输入**: 所有前序工作流的输出
**输出**: 综合分析摘要
**关键功能**:
- 关键信息提取
- 摘要自动生成
- 重点突出显示
- 可读性优化

### 8. Reporter - 报告整合器
**职责**: 整合所有输出，生成最终报告
**输入**: Summarizer的摘要
**输出**: 最终报告 (.md/.docx/.pdf)
**关键功能**:
- 内容整合
- 格式转换
- 样式应用
- 输出质量检查

### 9. Scheduler - 日程规划者
**职责**: 管理法律期限和工时统计
**输入**: 法院文件、工作记录
**输出**: 期限提醒、时间线、工时报表
**关键功能**:
- 法定期限计算
- 案件时间线管理
- 工时统计分析
- 期限风险预警

### 10. Reviewer - 智能审查器
**职责**: 质量审查和验证（作为Subagent被调用）
**输入**: 其他Agent的输出
**输出**: 质量评估报告、改进建议
**关键功能**:
- 跨Agent质量审查
- 全局一致性检查
- 风险识别与预警
- A/B/C/D四级质量评分

---

## 三层质量保障体系

为确保法律文书质量，系统建立了三层质量保障体系：

### 第一层：内嵌验证机制
增强所有10个Agent的内置验证能力：
- **DocAnalyzer**: OCR识别质量、要素提取完整性检查
- **EvidenceAnalyzer**: 证据三性验证（真实性、合法性、关联性）
- **Writer**: 法律术语准确性、引用格式规范、逻辑严密性
- **Strategist**: SWOT分析客观性、风险评估准确性

### 第二层：关键Agent专项审查
Writer和Strategist输出后自动触发深度审查：
- 建立审查标准库和检查清单
- 提供针对性优化建议

### 第三层：独立Reviewer Agent
作为第10个Agent，智能审查器负责：
- **自动触发（高风险案件）**：标的额>100万、新型法律问题、社会重大影响
- **条件触发（重要文书）**：上诉状、代理词、质证意见书、法律意见书
- **异常触发（质量异常）**：前置Agent输出质量评分<80分或置信度<90%
- **手动触发（用户要求）**：用户明确指令进行质量审查

---

## 记忆分层系统

基于Claude Code架构设计的三层记忆系统，为所有Agent提供分层的上下文记忆支持：

### 案件级记忆 (Case-Level)
- **位置**: `output/[案件编号]/06_日程管理/[案件编号].md`
- **格式**: Markdown
- **内容**: 案件上下文、工作记录、时间线、状态变更、决策历史
- **生命周期**: 案件全程
- **更新机制**: Agent自动更新

### 个人级记忆 (Personal-Level)
- **位置**: `.claude/memory/` 文件夹
- **格式**: Markdown
- **内容**: 律师偏好、工作习惯、个性化设置、常用模板、效率优化
- **生命周期**: 长期保持
- **更新机制**: 人工审核后修改

### 系统级记忆 (System-Level)
- **位置**: 根目录 `claude.md` 文件
- **格式**: Markdown
- **内容**: 全局配置、系统规则、法律知识库、共享经验、最佳实践
- **生命周期**: 永久维护
- **更新机制**: 人工审核后修改

---

## 自动化工作流编排

系统支持15种场景的智能识别和自动工作流选择：

### 场景识别规则
- **文档类型识别**: 起诉状、证据材料、庭审笔录、判决书等
- **场景匹配**: 被告应诉、新证据质证、庭审后分析等
- **工作流推荐**: 基于场景自动选择最佳Agent组合

### 15种自动识别场景
1. 被告应诉、2. 新证据质证、3. 庭审后分析、4. 判决分析
5. 诉前沟通、6. 诉讼中沟通、7. 原告起诉、8. 委托材料制作
9. 保全申请、10. 上诉材料、11. 法律意见书、12. 律师函
13. 强制执行申请、14. 调解协议、15. 异议申请

### 智能编排机制
- **一键启动**: 用户只需描述需求或上传文件
- **自动分析**: 系统自动识别场景和文档类型
- **智能推荐**: 基于场景推荐最佳工作流组合
- **并行执行**: 支持部分Agent并行处理提高效率

---

## 文档管理架构

### 整合式目录结构
```
output/[案件编号]/
├── 01_案件分析/              # DocAnalyzer + Strategist输出
├── 02_法律研究/              # IssueIdentifier + Researcher输出
├── 03_证据材料/              # EvidenceAnalyzer输出
├── 04_法律文书/              # Writer输出（12种子类型）
│   ├── 起诉状/
│   ├── 答辩状/
│   ├── 代理词/
│   ├── 质证意见书/
│   ├── 申请书/
│   ├── 上诉状/
│   ├── 律师函/
│   ├── 调解协议/
│   ├── 保全申请/
│   ├── 执行申请/
│   ├── 法律意见书/
│   └── 其他文书/
├── 05_综合报告/              # Summarizer + Reporter输出
└── 06_日程管理/              # Scheduler输出
    ├── 日程安排/              # 案件时间线管理
    ├── 工时统计/              # 工作时间记录和报表
    ├── 期限提醒/              # 法定期限预警
    ├── [案件编号].yaml        # 案件管理看板数据
    ├── [案件编号].md          # 案件工作记录
    └── 工作记录模板.md        # 工作记录格式模板
```

### 双版本设计
- **YAML版本** (`[案件编号].yaml`): 用于看板数据，支持自动化数据提取和汇总
- **MD版本** (`[案件编号].md`): 用于工作记录，支持人类可读和Agent解析

### 智能分类机制
- **材料归属识别**: 案号提取、案件匹配、新案件创建
- **材料类型分析**: 根据文档内容和特征自动分类
- **自动放置流程**: 根据类型智能分配到对应目录
- **批量处理支持**: 支持ZIP压缩包和多文件并行处理

---

## 数据流设计

```
输入文档
   │
   ▼
┌──────────┐     ┌──────────────┐     ┌──────────────┐
│DocAnalyzer│───▶│EvidenceAnalyzer│───▶│IssueIdentifier│
│(上下文1) │     │(上下文1+2)   │     │(上下文1+2+3)│
└──────────┘     └──────────────┘     └──────────────┘
                                           │
                                           ▼
┌──────────┐     ┌──────────────┐     ┌──────────────┐
│Reporter  │◀────│Summarizer    │◀────│Writer       │
│(最终)    │     │(汇总所有)    │     │(所有前置)   │
└──────────┘     └──────────────┘     └──────────────┘
                     ▲                    │
                     │                    │
               ┌──────────────┐     ┌──────────────┐
               │Strategist    │◀────│Researcher    │
               │(所有前置)    │     │(所有前置)    │
               └──────────────┘     └──────────────┘
```

### 上下文传递原则
1. **渐进式增长**: 每个工作流只添加自己的输出，保持上下文精简
2. **按需传递**: 只传递下一工作流必需的数据
3. **状态独立**: 每个工作流的上下文相对独立
4. **可回溯**: 支持中间结果的访问和回溯

---

## 技术栈

### 核心技术
- **AI框架**: Claude Code
- **文档处理**:
  - .docx: python-docx / Mammoth
  - .pdf: PyPDF2 / pdfplumber
- **格式转换**:
  - Markdown: markdown库
  - HTML: BeautifulSoup
- **数据存储**:
  - 临时数据: 文件系统
  - 结构化数据: JSON
- **工作流引擎**: 待定 (待评估Prefect、Airflow等)

### 开发工具
- **语言**: Python 3.9+
- **包管理**: pip
- **配置管理**: JSON
- **日志记录**: Python logging

---

## 部署架构

### 开发环境
```
本地开发机器
├── 源代码
├── 配置文件
├── 测试数据
└── 开发工具
```

### 生产环境
```
部署架构待完善 (将在阶段三详细设计)
├── 计算资源
├── 存储资源
├── 网络配置
└── 监控告警
```

---

## 扩展性考虑

### 水平扩展
- 工作流支持并行执行
- 可增加多个处理节点
- 支持负载均衡

### 垂直扩展
- 可添加新的工作流模块
- 可扩展文档格式支持
- 可增强AI模型能力

### 功能扩展
- 多案件并行处理
- 案件类型定制化
- 报告模板扩展
- 多语言支持

---

## 性能考量

### 关键指标
- **响应时间**: 单个工作流 < 30秒
- **吞吐量**: 支持5+案件并行处理
- **准确性**: > 90% (待定义评估标准)
- **资源消耗**: Token使用量最小化

### 优化策略
- 上下文最小化减少token消耗
- 并行执行提高处理速度
- 缓存机制减少重复计算
- 异步I/O提高资源利用率

---

## 安全与合规

### 数据安全
- 敏感信息脱敏
- 数据加密存储
- 访问控制机制

### 法律合规
- 遵守数据保护法规
- 确保分析结果准确
- 提供审计追踪能力

---

## 维护与监控

### 日常维护
- 日志分析
- 性能监控
- 错误处理
- 定期备份

### 监控指标
- 工作流执行成功率
- 平均处理时间
- 错误率和错误类型
- 资源使用率

---

## 相关文档
- [项目路线图](ROADMAP.md)
- [决策记录](DECISIONS.md)
- [任务清单](../status/TASKS.md)
- [变更记录](../status/CHANGELOG.md)
