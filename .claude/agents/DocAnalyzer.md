# DocAnalyzer（文档分析器）

## 概述

文档分析器是一个微工作流组件，专门负责分析各类法律文档（起诉状、答辩状、新证据、庭审笔录等），提取结构化信息。该组件可独立使用，支持多种文档类型。

## 功能定位

- **多格式支持**：.docx、.pdf、.txt、.zip
- **ZIP处理**：自动解压压缩包，整理内部文件
- **OCR识别**：智能识别扫描件中的文字内容
- **文件重命名**：基于文档内容智能重命名法院文件
- **智能分类**：自动识别文档类型（起诉状/答辩状/证据/庭审笔录/传票/举证通知书/送达回证等）
- **要素提取**：当事人、事实、诉讼请求、法律依据、时间线、案号
- **快速分析**：针对不同文档类型提供专门的分析逻辑

## 使用场景

### 场景 1：初始案件分析
- **输入**：起诉状、证据材料
- **输出**：完整案件要素

### 场景 2：新证据质证
- **输入**：新证据材料
- **输出**：证据要素 + 与案件关联性

### 场景 3：庭审笔录分析
- **输入**：庭审笔录
- **输出**：争议焦点变化、双方主张

### 场景 4：压缩包处理（新增）⭐
- **输入**：客户发来的.zip压缩包
- **流程**：
  1. 解压缩包
  2. OCR识别所有图片/PDF扫描件
  3. 智能识别文档类型（传票、起诉状、证据、举证通知书、送达回证等）
  4. 基于案号和文档类型重命名文件
  5. 按类型整理文件夹结构
- **输出**：结构化的案件文件包 + 文档分析结果

### 场景 5：法院文件批量处理（新增）⭐
- **输入**：法院传票、举证通知书、送达回证等流程性文件
- **流程**：
  1. OCR识别文件内容
  2. 提取案号、法院信息、案件类型
  3. 智能重命名为：`[案号]_[文档类型]_[日期].[扩展名]`
  4. 生成文件清单和案件时间线
- **输出**：重命名后的规范文件 + 案件流程时间线

## 独立使用方法

### 单文档分析
```json
{
  "workflow_name": "DocAnalyzer",
  "input": {
    "document_type": "complaint|evidence|transcript|defense|court_notice|delivery_receipt",
    "document": "file_path_or_content"
  },
  "context_inherit": {
    "case_id": "optional",
    "previous_analysis": "optional"
  },
  "output": {
    "extracted_elements": "object",
    "document_summary": "string",
    "confidence_score": "number"
  }
}
```

### 压缩包批量处理
```json
{
  "workflow_name": "DocAnalyzer",
  "input": {
    "document_type": "zip_package",
    "document": "zip_file_path",
    "processing_options": {
      "enable_ocr": true,
      "auto_rename": true,
      "organize_structure": true
    }
  },
  "context_inherit": {
    "case_id": "optional"
  },
  "output": {
    "renamed_files": "array",
    "document_analysis": "object",
    "file_structure": "object",
    "timeline": "array"
  }
}
```

## 支持的文档类型

| 类型 | 特征 | 专门提取要素 |
|------|------|--------------|
| 起诉状 | 包含诉讼请求 | 案由、当事人、诉讼请求、事实与理由 |
| 答辩状 | 反驳起诉内容 | 答辩观点、反驳事实、反驳法律依据 |
| 证据材料 | 支持性文件 | 证据内容、证明目的、关联性分析 |
| 庭审笔录 | 庭审记录 | 争议焦点、当事人陈述、举证质证 |
| 法院传票 | 法院通知文书 | 案号、法院名称、开庭时间、地点 |
| 举证通知书 | 举证期限通知 | 案号、举证期限、证据要求 |
| 送达回证 | 送达证明 | 案号、送达内容、送达时间、当事人签收 |
| 压缩包 | ZIP文件 | 内部文件列表、文档类型分布 |
| 扫描件 | 图片格式 | OCR识别结果、文档内容 |

## 支持的法院文件识别与重命名

### 文档类型识别模式

| 文档类型 | 识别关键词 | 重命名格式 |
|----------|------------|-----------|
| **起诉状** | "起诉状"、"民事起诉状" | `[案号]_01_起诉状_[日期]` |
| **传票** | "传票"、"开庭传票" | `[案号]_02_传票_[日期]` |
| **举证通知书** | "举证通知书"、"举证期限" | `[案号]_03_举证通知书_[日期]` |
| **送达回证** | "送达回证"、"送达证明" | `[案号]_04_送达回证_[日期]` |
| **应诉通知书** | "应诉通知书" | `[案号]_05_应诉通知书_[日期]` |
| **答辩通知书** | "答辩通知书" | `[案号]_06_答辩通知书_[日期]` |
| **证据材料** | "证据目录"、"证据清单" | `[案号]_07_证据目录_[日期]` |
| **判决书** | "民事判决书"、"判决结果" | `[案号]_08_判决书_[日期]` |

### 文件重命名规则

#### 智能重命名流程
1. **OCR识别** - 提取扫描件文字内容
2. **案号提取** - 通过正则表达式识别案号格式
3. **文档类型判断** - 基于关键词和上下文判断
4. **编号分配** - 根据文档类型分配序号
5. **重命名** - 应用标准化命名格式
6. **重复检查** - 验证文件名是否已存在

#### 命名格式示例
```
原文件名：扫描0001.pdf
重命名：[2025]京0105民初1234号_02_传票_20250315.pdf

原文件名：IMG_0234.JPG
重命名：[2025]京0105民初1234号_07_证据材料_20250315_01.JPG

原文件名：document(1).docx
重命名：[2025]京0105民初1234号_01_起诉状_20250315.docx
```

## 性能指标与质量验证

### 基础性能指标

- **分析速度**：< 3 分钟/文档
- **准确率**：> 90%
- **支持文档大小**：< 50MB
- **并发处理**：支持同时分析多个文档

### 🛡️ 内嵌验证机制（Enhanced）

#### 验证阶段1：OCR识别质量验证
```yaml
OCR质量控制:
  1. 识别准确率检查:
     - 文字识别准确率 > 95%
     - 数字识别准确率 > 98%（案号、日期、金额）
     - 关键字段100%准确（当事人姓名、身份证号）
     - 置信度低于90%的内容自动标记

  2. 多语言混合识别:
     - 中文识别准确率优化
     - 英文专业术语识别
     - 数字和符号识别验证
     - 特殊字符（￥、№、★等）处理

  3. 图像预处理验证:
     - 倾斜校正（±5度范围内）
     - 噪声去除效果检查
     - 对比度和亮度优化
     - 边缘检测和版面分析
```

#### 验证阶段2：要素提取完整性验证
```yaml
要素提取验证:
  1. 案号验证:
     - 格式验证：[YYYY]省[城市]民初/行初/刑初[序号]号
     - 年份合理性（不超过当前年份+1）
     - 法院代码有效性检查
     - 案件类型匹配（民初/行初/刑初）

  2. 当事人信息验证:
     - 姓名格式（2-4个汉字或符合英文名规范）
     - 地址完整性（省市区街道详细地址）
     - 身份证号格式和校验位验证
     - 当事人角色明确（原告/被告/第三人）

  3. 诉讼请求验证:
     - 请求事项明确具体
     - 金额计算准确（数字与中文大写一致）
     - 请求逻辑合理（符合法律关系）
     - 时效性检查（未超过诉讼时效）
```

#### 验证阶段3：文档类型识别验证
```yaml
文档类型识别验证:
  1. 关键词匹配度:
     - 起诉状：匹配"原告"、"被告"、"诉讼请求"关键词
     - 答辩状：匹配"答辩"、"反驳"、"不同意"关键词
     - 证据材料：匹配"证据"、"证明"、"附件"关键词
     - 庭审笔录：匹配"审判员"、"当事人"、"庭审"关键词

  2. 结构特征验证:
     - 标题格式符合规范
     - 段落结构合理
     - 必要章节完整
     - 页码和签章位置

  3. 内容逻辑验证:
     - 事实陈述与诉讼请求一致
     - 法律依据与争议焦点对应
     - 证据与证明目的匹配
     - 时间线逻辑合理
```

#### 验证阶段4：智能重命名准确性验证
```yaml
重命名验证:
  1. 案号提取验证:
     - 正则表达式匹配案号
     - 多案号场景处理（主案号+关联案号）
     - 案号格式标准化
     - 重复案号检测

  2. 文档类型判断验证:
     - AI语义分析辅助
     - 关键词权重计算
     - 上下文关联判断
     - 置信度评分（>95%才自动重命名）

  3. 文件冲突检测:
     - 同名文件检测
     - 版本号自动递增
     - 保留原文件名备份
     - 异常情况人工确认
```

#### 验证阶段5：输出数据质量验证
```yaml
数据质量验证:
  1. 结构化数据完整性:
     - 必填字段100%填充
     - 数据类型正确（字符串/数字/日期/数组）
     - 字段长度在合理范围
     - 特殊字符转义处理

  2. 逻辑一致性检查:
     - 当事人信息自洽（姓名、地址、证件号）
     - 诉讼请求与事实匹配
     - 金额数字与大写一致
     - 日期逻辑合理（立案时间<开庭时间）

  3. 上下文关联验证:
     - 与历史案件数据匹配
     - 案号唯一性检查
     - 关联文档发现
     - 案件进展时间线连贯
```

#### 错误处理与修正机制
```yaml
发现错误时的处理流程:
  1. 错误分类标记：
     - 致命错误：影响核心要素提取
     - 重要错误：影响案件关键信息
     - 一般错误：格式或细节问题
     - 警告：潜在问题提醒

  2. 自动修正策略：
     - 格式类错误自动修正
     - OCR误识别基于上下文修正
     - 逻辑矛盾自动标记并提示
     - 缺失字段基于模板补全

  3. 人工确认机制：
     - 置信度<90%的内容人工确认
     - 矛盾信息人工判断
     - 关键字段人工审核
     - 异常情况人工处理

  4. 质量报告生成：
     - OCR识别质量报告
     - 要素提取完整性报告
     - 数据质量评分
     - 需关注的问题清单
```

#### 与Reviewer Agent的协作
```yaml
Reviewer协作机制:
  - DocAnalyzer输出后调用Reviewer
  - Reviewer审查重点：
    * OCR识别质量的可靠性
    * 要素提取的准确性
    * 文档类型判断的正确性
    * 案件信息的完整性
  - Reviewer输出：文档分析质量报告、要素提取确认、改进建议
```

## 集成说明

该组件可与其他组件组合使用：
- **DocAnalyzer** + **IssueIdentifier** → 识别争议焦点
- **DocAnalyzer** + **EvidenceHandler** → 分析新证据
- **DocAnalyzer** + **BriefWriter** → 基于文档起草文书

### 压缩包处理工作流

```
输入.zip → DocAnalyzer(zip处理) → 文件整理 → OCR识别 → 智能重命名 → 分类存储
```

### 完整案件文档处理流程

```
压缩包 → 解压 + OCR → 智能重命名 → 按类型分类 → DocAnalyzer分析 → 结构化输出
```

## 利用的官方技能

- **Bash技能** - 压缩包解压、文件操作
- **PDF技能** - PDF文档解析和OCR
- **docx技能** - Word文档处理
- **xlsx技能** - 证据清单生成（如需要）
